#!/bin/bash
# ================================================================
# Full Pipeline Provisioning for Vast.ai ComfyUI
# ================================================================
# GPU-agnostic — works on RTX 5090, A100, H100, A6000, etc.
#
# Covers ALL pipeline workflows:
#   - Z-Image Turbo / Base     (image generation)
#   - LTX-2 two-stage          (video generation)
#   - workflow_tts_only.json    (Qwen3-TTS → audio)
#   - workflow_video_with_audio (LTX-2 + audio lip-sync video)
#
# Run on a fresh Vast.ai ComfyUI instance via SSH:
#   bash provision_full.sh
#
# Total download: ~55GB
# Time: ~15-20 min on fast connection
# ================================================================

set -e

echo "========================================================"
echo " Full Pipeline Provisioning (All Workflows)"
echo "========================================================"

# ============================================
# PART 1: GPU DETECTION
# ============================================
echo ""
echo "--- GPU Detection ---"

GPU_NAME=$(nvidia-smi --query-gpu=name --format=csv,noheader 2>/dev/null | head -1 || echo "Unknown")
GPU_VRAM=$(nvidia-smi --query-gpu=memory.total --format=csv,noheader,nounits 2>/dev/null | head -1 || echo "0")
echo "Detected GPU: $GPU_NAME (${GPU_VRAM}MB VRAM)"

# ============================================
# PART 2: SYSTEM SETUP & FOLDER DETECTION
# ============================================
echo ""
echo "--- System Setup ---"

cd /workspace
# Detect if folder is 'ComfyUI' or 'comfyui' and enter it
if [ -d "ComfyUI" ]; then
    COMFY_DIR="ComfyUI"
else
    COMFY_DIR="comfyui"
fi
cd "$COMFY_DIR"
COMFY_ROOT="$(pwd)"
echo "Installing in: $COMFY_ROOT"

# Install Git LFS + ffmpeg
apt-get update && apt-get install -y git-lfs ffmpeg
git lfs install

# CRUCIAL: ComfyUI uses its own venv at /venv/main/, NOT system Python.
PIP="/venv/main/bin/pip"
PYTHON="/venv/main/bin/python"

# Install Python libraries for 4-bit models
$PIP install 'accelerate>=1.1.0' 'bitsandbytes>=0.43.0' 'huggingface_hub'

# ============================================
# PART 3: INSTALL ALL CUSTOM NODES
# ============================================
echo ""
echo "--- Setting up Custom Nodes ---"

cd custom_nodes

FAILED_NODES=""

# Helper: install a custom node with full verification
install_node() {
    local name="$1"
    local repo="$2"
    local extras="$3"
    local max_retries=2
    local attempt=0

    while [ $attempt -lt $max_retries ]; do
        attempt=$((attempt + 1))
        echo ""
        echo "[$name] Attempt $attempt/$max_retries"

        if [ -d "$name" ]; then
            echo "[$name] Removing existing directory..."
            rm -rf "$name"
        fi

        echo "[$name] Cloning..."
        if ! git clone --depth 1 "$repo" 2>&1; then
            echo "[$name] ERROR: git clone failed"
            continue
        fi

        if [ ! -d "$name/.git" ]; then
            echo "[$name] ERROR: .git directory missing after clone"
            rm -rf "$name"
            continue
        fi

        cd "$name"

        if [ -f "requirements.txt" ]; then
            echo "[$name] Installing pip dependencies..."
            if ! $PIP install -r requirements.txt 2>&1; then
                echo "[$name] ERROR: pip install failed"
                cd ..
                rm -rf "$name"
                continue
            fi
        fi

        if [ -n "$extras" ]; then
            echo "[$name] Running extras..."
            if ! eval "$extras" 2>&1; then
                echo "[$name] ERROR: extras command failed"
                cd ..
                rm -rf "$name"
                continue
            fi
        fi

        cd ..

        if [ -d "$name" ] && [ -d "$name/.git" ]; then
            local py_count
            py_count=$(find "$name" -maxdepth 2 -name "*.py" | head -5 | wc -l)
            if [ "$py_count" -gt 0 ]; then
                echo "[$name] OK — installed and verified ($py_count+ .py files found)"
                return 0
            else
                echo "[$name] ERROR: No .py files found after install"
                rm -rf "$name"
                continue
            fi
        fi
    done

    echo "[$name] FAILED after $max_retries attempts!"
    FAILED_NODES="$FAILED_NODES $name"
    return 1
}

# Temporarily allow failures so one bad node doesn't abort the whole script
set +e

# --- LTX-Video (LTXV* nodes, LatentUpscaleModelLoader, Audio VAE nodes) ---
install_node "ComfyUI-LTXVideo" "https://github.com/Lightricks/ComfyUI-LTXVideo.git"

# --- ComfyMath (ManualSigmas) ---
install_node "ComfyMath" "https://github.com/evanspearman/ComfyMath.git"

# --- ComfyUI-Impact-Pack (ResizeImageMaskNode, SolidMask) ---
install_node "ComfyUI-Impact-Pack" "https://github.com/ltdrdata/ComfyUI-Impact-Pack.git" \
    '[ -f "install.py" ] && $PYTHON install.py'

# --- TTP Toolset ---
install_node "Comfyui_TTP_Toolset" "https://github.com/TTPlanetPig/Comfyui_TTP_Toolset.git" \
    '$PIP install opencv-python numpy'

# --- VideoHelperSuite (VHS_VideoCombine) ---
install_node "ComfyUI-VideoHelperSuite" "https://github.com/Kosinkadink/ComfyUI-VideoHelperSuite.git"

# --- KJNodes (ImageResizeKJv2, SimpleCalculatorKJ, INTConstant) ---
install_node "ComfyUI-KJNodes" "https://github.com/kijai/ComfyUI-KJNodes.git"

# --- rgthree-comfy (Seed, PrimitiveBoolean, Power Lora Loader) ---
install_node "rgthree-comfy" "https://github.com/rgthree/rgthree-comfy.git"

# --- Qwen3-TTS (AILab_Qwen3TTSVoiceClone, TrimAudioDuration) ---
# Pin transformers <5 to avoid breaking changes in v5.0
install_node "ComfyUI-QwenTTS" "https://github.com/1038lab/ComfyUI-QwenTTS.git" \
    '$PIP install accelerate>=1.12.0 einops>=0.8.1 librosa>=0.11.0 soundfile>=0.13.1 tiktoken>=0.12.0 torchaudio sentencepiece>=0.2.1 "transformers>=4.51,<5"'

# --- MTB Nodes (Audio Duration) ---
install_node "comfy_mtb" "https://github.com/melMass/comfy_mtb.git"

set -e

echo ""
echo "========== CUSTOM NODE INSTALL SUMMARY =========="
if [ -z "$FAILED_NODES" ]; then
    echo "ALL 9 custom nodes installed and verified!"
else
    echo "FAILED NODES:$FAILED_NODES"
    echo "These nodes will need manual installation."
fi
echo "================================================="

cd ..

# ============================================
# PART 4: PATCH LTXVScheduler (SIGMOID FIX)
# ============================================
echo ""
echo "--- Applying LTXVScheduler Sigmoid Fix ---"
echo "Prevents OverflowError with audio-visual latents"

# Find the scheduler file
SCHEDULER_FILE=$(find custom_nodes/ComfyUI-LTXVideo -name "*.py" -exec grep -l "math.exp" {} \; 2>/dev/null | head -1)

if [ -n "$SCHEDULER_FILE" ]; then
    # Check if already patched
    if grep -q "sigmoid" "$SCHEDULER_FILE" 2>/dev/null; then
        echo "[skip] Sigmoid fix already applied"
    else
        echo "Patching: $SCHEDULER_FILE"
        # Replace raw exp() with sigmoid form to prevent overflow
        # Original: mu = math.exp(sigma_shift)  (overflows when sigma_shift > ~700)
        # Fixed:    mu = 1.0 / (1.0 + math.exp(-sigma_shift))  (always 0-1, never overflows)
        $PYTHON -c "
import re, sys

scheduler_file = '$SCHEDULER_FILE'
with open(scheduler_file, 'r') as f:
    content = f.read()

# Look for the problematic exp pattern in sigma calculation
# Common patterns: math.exp(shift), exp(sigma_shift), etc.
original = content

# Pattern 1: mu = math.exp(...)
content = re.sub(
    r'(\s+)(mu\s*=\s*)math\.exp\(([^)]+)\)',
    r'\1# Sigmoid fix: prevents OverflowError with large audio-visual latents\n\1_shift = \3\n\1\2(1.0 / (1.0 + math.exp(-_shift))) if _shift < 500 else 1.0',
    content
)

if content != original:
    with open(scheduler_file, 'w') as f:
        f.write(content)
    print('  Sigmoid fix applied successfully!')
else:
    # Try alternate pattern
    content = original
    content = re.sub(
        r'math\.exp\(([^)]*sigma[^)]*)\)',
        r'(1.0 / (1.0 + math.exp(-(\1)))) if (\1) < 500 else 1.0',
        content
    )
    if content != original:
        with open(scheduler_file, 'w') as f:
            f.write(content)
        print('  Sigmoid fix applied (alternate pattern)!')
    else:
        print('  WARNING: Could not find exp pattern to patch.')
        print('  You may need to manually apply the sigmoid fix.')
        print('  File: ' + scheduler_file)
"
    fi
else
    echo "WARNING: Could not find LTXVScheduler source file."
    echo "The sigmoid fix may need to be applied manually if audio workflows fail."
fi

# ============================================
# PART 5: DOWNLOAD LTX-VIDEO MODELS
# ============================================
echo ""
echo "--- Downloading LTX-Video Models ---"

# A. LTX-2 Checkpoint (~19GB)
cd models/checkpoints
if [ ! -f "ltx-2-19b-distilled-fp8.safetensors" ]; then
    echo "Downloading LTX-2 Checkpoint (~19GB)..."
    wget -q --show-progress -O ltx-2-19b-distilled-fp8.safetensors \
        "https://huggingface.co/Lightricks/LTX-2/resolve/main/ltx-2-19b-distilled-fp8.safetensors?download=true"
else
    echo "[skip] LTX-2 Checkpoint already exists"
fi

# B. LTX Upscaler
mkdir -p ../latent_upscale_models
cd ../latent_upscale_models
if [ ! -f "ltx-2-spatial-upscaler-x2-1.0.safetensors" ]; then
    echo "Downloading LTX Upscaler..."
    wget -q --show-progress -O ltx-2-spatial-upscaler-x2-1.0.safetensors \
        "https://huggingface.co/Lightricks/LTX-2/resolve/main/ltx-2-spatial-upscaler-x2-1.0.safetensors?download=true"
else
    echo "[skip] LTX Upscaler already exists"
fi

# C. Gemma 3 Text Encoder (~7GB)
mkdir -p ../text_encoders
cd ../text_encoders
if [ ! -d "gemma-3-12b-it-bnb-4bit" ]; then
    echo "Downloading Gemma 3 12B 4-bit (~7GB)..."
    git clone https://huggingface.co/unsloth/gemma-3-12b-it-bnb-4bit
else
    echo "[skip] Gemma 3 already exists"
fi

# ============================================
# PART 6: DOWNLOAD Z-IMAGE-TURBO (SPLIT FILES)
# ============================================
echo ""
echo "--- Setting up Z-Image-Turbo ---"

cd "$COMFY_ROOT/models"

# A. Text Encoder (Qwen)
mkdir -p clip
cd clip
if [ ! -f "qwen_3_4b.safetensors" ]; then
    echo "Downloading Qwen Text Encoder..."
    wget -q --show-progress -O qwen_3_4b.safetensors \
        "https://huggingface.co/Comfy-Org/z_image_turbo/resolve/main/split_files/text_encoders/qwen_3_4b.safetensors"
else
    echo "[skip] Qwen Text Encoder already exists"
fi
cd ..

# B. Diffusion Model (UNet)
mkdir -p unet
cd unet
if [ ! -f "z_image_turbo_bf16.safetensors" ]; then
    echo "Downloading Z-Image Turbo UNet..."
    wget -q --show-progress -O z_image_turbo_bf16.safetensors \
        "https://huggingface.co/Comfy-Org/z_image_turbo/resolve/main/split_files/diffusion_models/z_image_turbo_bf16.safetensors"
else
    echo "[skip] Z-Image Turbo UNet already exists"
fi
cd ..

# C. VAE
mkdir -p vae
cd vae
if [ ! -f "z_image_turbo_ae.safetensors" ]; then
    echo "Downloading Z-Image VAE..."
    wget -q --show-progress -O z_image_turbo_ae.safetensors \
        "https://huggingface.co/Comfy-Org/z_image_turbo/resolve/main/split_files/vae/ae.safetensors"
else
    echo "[skip] Z-Image VAE already exists"
fi
cd ..

# ============================================
# PART 6b: DOWNLOAD Z-IMAGE-BASE (UNET ONLY)
# ============================================
echo ""
echo "--- Setting up Z-Image-Base ---"

cd "$COMFY_ROOT/models"
cd unet
if [ ! -f "z_image_bf16.safetensors" ]; then
    echo "Downloading Z-Image Base UNet (12.3 GB)..."
    wget -q --show-progress -O z_image_bf16.safetensors \
        "https://huggingface.co/Comfy-Org/z_image/resolve/main/split_files/diffusion_models/z_image_bf16.safetensors"
else
    echo "[skip] Z-Image Base UNet already exists"
fi
cd ..

# ============================================
# PART 7: QWEN3-TTS MODELS
# ============================================
echo ""
echo "--- Downloading Qwen3-TTS Models ---"

cd "$COMFY_ROOT"
mkdir -p models/TTS/Qwen3-TTS

# 7a. 1.7B CustomVoice model (~4.5GB)
if [ ! -f "models/TTS/Qwen3-TTS/Qwen3-TTS-12Hz-1.7B-CustomVoice/model.safetensors" ]; then
    echo "Downloading Qwen3-TTS 1.7B CustomVoice (~4.5GB)..."
    $PYTHON -c "
from huggingface_hub import snapshot_download
snapshot_download(
    'Qwen/Qwen3-TTS-12Hz-1.7B-CustomVoice',
    local_dir='$COMFY_ROOT/models/TTS/Qwen3-TTS/Qwen3-TTS-12Hz-1.7B-CustomVoice'
)
"
else
    echo "[skip] Qwen3-TTS 1.7B CustomVoice already exists"
fi

# 7b. Tokenizer (~682MB)
if [ ! -f "models/TTS/Qwen3-TTS/Qwen3-TTS-Tokenizer-12Hz/model.safetensors" ]; then
    echo "Downloading Qwen3-TTS Tokenizer (~682MB)..."
    $PYTHON -c "
from huggingface_hub import snapshot_download
snapshot_download(
    'Qwen/Qwen3-TTS-Tokenizer-12Hz',
    local_dir='$COMFY_ROOT/models/TTS/Qwen3-TTS/Qwen3-TTS-Tokenizer-12Hz'
)
"
else
    echo "[skip] Qwen3-TTS Tokenizer already exists"
fi

echo "Qwen3 TTS setup complete!"

# ============================================
# PART 8: MARKER FILES + RESTART
# ============================================
echo ""

touch /workspace/.ltx2_ready
touch /workspace/.tts_split_ready

echo "=============================================="
echo " ALL DONE! Restarting ComfyUI..."
echo "=============================================="
echo ""
echo " GPU: $GPU_NAME (${GPU_VRAM}MB VRAM)"
echo ""
echo " Custom nodes: 9 installed"
echo "   ComfyUI-LTXVideo, ComfyMath, ComfyUI-Impact-Pack,"
echo "   Comfyui_TTP_Toolset, ComfyUI-VideoHelperSuite,"
echo "   ComfyUI-KJNodes, rgthree-comfy, ComfyUI-QwenTTS, comfy_mtb"
echo ""
echo " Models:"
echo "   LTX-2 19B fp8         (~19GB) - video generation"
echo "   LTX-2 upscaler        (~1GB)  - stage 2 upscale"
echo "   Gemma-3-12B 4bit      (~7GB)  - text encoder (CLIP)"
echo "   Z-Image Turbo UNet    (~6GB)  - image generation"
echo "   Z-Image Base UNet     (~12GB) - image generation"
echo "   Z-Image VAE + Qwen    (~5GB)  - image enc/dec + text"
echo "   Qwen3-TTS 1.7B        (~4.5GB)- voice synthesis"
echo "   Qwen3-TTS Tokenizer   (~682MB)- audio codec"
echo ""
echo " Patches applied:"
echo "   LTXVScheduler sigmoid fix (prevents audio latent overflow)"
echo ""

if command -v supervisorctl &> /dev/null; then
    supervisorctl restart comfyui
    echo "ComfyUI restarted!"
    echo ""
    echo "  Supported workflows:"
    echo "    - Z-Image Turbo/Base    (image gen)"
    echo "    - LTX-2 two-stage       (video gen)"
    echo "    - TTS-only              (Qwen3-TTS → audio)"
    echo "    - Video-with-audio v2   (LTX-2 lip-sync from pre-gen audio)"
else
    echo "Please restart ComfyUI manually."
fi

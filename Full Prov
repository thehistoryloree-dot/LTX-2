#!/bin/bash
# LTX-2 RTX 5090 Complete Setup Script for Vast.ai ComfyUI instances
# Combines: RTX 5090 flags + Model downloads + Custom nodes

set -e

echo "=============================================="
echo "LTX-2 + RTX 5090 Complete Provisioning Script"
echo "=============================================="

# ============================================
# PART 1: RTX 5090 CONFIGURATION FLAGS
# ============================================
echo ""
echo "--- Configuring RTX 5090 Flags ---"

# Update /etc/environment to add memory management flags
if grep -q "COMFYUI_ARGS=" /etc/environment; then
    if ! grep -q "disable-xformers" /etc/environment; then
        sed -i 's/COMFYUI_ARGS="\([^"]*\)"/COMFYUI_ARGS="\1 --disable-xformers --disable-smart-memory"/' /etc/environment
        echo "Updated /etc/environment with RTX 5090 flags"
    else
        echo "/etc/environment already configured"
    fi
fi

# Also update the default in comfyui.sh for persistence
if [ -f /opt/supervisor-scripts/comfyui.sh ]; then
    if ! grep -q "disable-xformers" /opt/supervisor-scripts/comfyui.sh; then
        sed -i 's/--enable-cors-header}/--enable-cors-header --disable-xformers --disable-smart-memory}/' /opt/supervisor-scripts/comfyui.sh
        echo "Updated comfyui.sh defaults"
    fi
fi

# ============================================
# PART 2: SYSTEM SETUP & FOLDER DETECTION
# ============================================
echo ""
echo "--- System Setup ---"

cd /workspace
# Detect if folder is 'ComfyUI' or 'comfyui' and enter it
if [ -d "ComfyUI" ]; then
    COMFY_DIR="ComfyUI"
else
    COMFY_DIR="comfyui"
fi
cd "$COMFY_DIR"
COMFY_ROOT="$(pwd)"
echo "Installing in: $COMFY_ROOT"

# Install Git LFS (Essential for large model downloads)
apt-get update && apt-get install -y git-lfs
git lfs install

# CRUCIAL: ComfyUI uses its own venv at /venv/main/, NOT system Python.
# Packages must be installed there for ComfyUI to see them.
PIP="/venv/main/bin/pip"
PYTHON="/venv/main/bin/python"

# Install Python libraries specifically for 4-bit LTX models (Crucial Fix)
$PIP install 'accelerate>=1.1.0' 'bitsandbytes>=0.43.0'

# ============================================
# PART 3: INSTALL ALL CUSTOM NODES
# ============================================
echo ""
echo "--- Setting up Custom Nodes ---"

cd "$COMFY_ROOT/custom_nodes"

FAILED_NODES=""

# Helper: install a custom node with full verification
# Checks: git clone completeness, pip deps, extras, and __init__.py presence
install_node() {
    local name="$1"
    local repo="$2"
    local extras="$3"
    local max_retries=2
    local attempt=0

    while [ $attempt -lt $max_retries ]; do
        attempt=$((attempt + 1))
        echo ""
        echo "[$name] Attempt $attempt/$max_retries"

        # Always start clean — remove any partial/broken install
        if [ -d "$name" ]; then
            echo "[$name] Removing existing directory..."
            rm -rf "$name"
        fi

        # 1. Git clone with verification
        echo "[$name] Cloning..."
        if ! git clone --depth 1 "$repo" 2>&1; then
            echo "[$name] ERROR: git clone failed"
            continue
        fi

        # Verify clone completed (has .git dir and at least an __init__.py or py files)
        if [ ! -d "$name/.git" ]; then
            echo "[$name] ERROR: .git directory missing after clone"
            rm -rf "$name"
            continue
        fi

        if [ ! -f "$name/__init__.py" ] && [ -z "$(ls "$name"/*.py 2>/dev/null)" ]; then
            echo "[$name] WARNING: No Python files found — clone may be incomplete"
        fi

        cd "$name"

        # 2. Install pip dependencies with exit code check
        if [ -f "requirements.txt" ]; then
            echo "[$name] Installing pip dependencies..."
            if ! $PIP install -r requirements.txt 2>&1; then
                echo "[$name] ERROR: pip install failed"
                cd ..
                rm -rf "$name"
                continue
            fi
        fi

        # 3. Run extras (install.py, extra pip packages, etc.)
        if [ -n "$extras" ]; then
            echo "[$name] Running extras..."
            if ! eval "$extras" 2>&1; then
                echo "[$name] ERROR: extras command failed"
                cd ..
                rm -rf "$name"
                continue
            fi
        fi

        cd ..

        # 4. Final verification — directory exists and has Python files
        if [ -d "$name" ] && [ -d "$name/.git" ]; then
            local py_count
            py_count=$(find "$name" -maxdepth 2 -name "*.py" | head -5 | wc -l)
            if [ "$py_count" -gt 0 ]; then
                echo "[$name] OK — installed and verified ($py_count+ .py files found)"
                return 0
            else
                echo "[$name] ERROR: No .py files found after install"
                rm -rf "$name"
                continue
            fi
        fi
    done

    # All retries exhausted
    echo "[$name] FAILED after $max_retries attempts!"
    FAILED_NODES="$FAILED_NODES $name"
    return 1
}

# Temporarily allow failures so one bad node doesn't abort the whole script
set +e

# --- LTX-Video ---
install_node "ComfyUI-LTXVideo" "https://github.com/Lightricks/ComfyUI-LTXVideo.git"

# --- ComfyMath ---
install_node "ComfyMath" "https://github.com/evanspearman/ComfyMath.git"

# --- ComfyUI-Impact-Pack ---
install_node "ComfyUI-Impact-Pack" "https://github.com/ltdrdata/ComfyUI-Impact-Pack.git" \
    '[ -f "install.py" ] && $PYTHON install.py'

# --- TTP Toolset ---
install_node "Comfyui_TTP_Toolset" "https://github.com/TTPlanetPig/Comfyui_TTP_Toolset.git" \
    '$PIP install opencv-python numpy'

# --- VideoHelperSuite ---
install_node "ComfyUI-VideoHelperSuite" "https://github.com/Kosinkadink/ComfyUI-VideoHelperSuite.git"

# --- KJNodes ---
install_node "ComfyUI-KJNodes" "https://github.com/kijai/ComfyUI-KJNodes.git"

# --- rgthree-comfy ---
install_node "rgthree-comfy" "https://github.com/rgthree/rgthree-comfy.git"

# Re-enable strict error handling
set -e

# --- Summary ---
echo ""
echo "========== CUSTOM NODE INSTALL SUMMARY =========="
if [ -z "$FAILED_NODES" ]; then
    echo "ALL 7 custom nodes installed and verified successfully!"
else
    echo "FAILED NODES:$FAILED_NODES"
    echo "These nodes will need manual installation."
fi
echo "================================================="

# ============================================
# PART 4: DOWNLOAD LTX-VIDEO MODELS
# ============================================
echo ""
echo "--- Downloading LTX-Video Models ---"

cd "$COMFY_ROOT/models"

# A. LTX-2 Checkpoints
cd checkpoints

# Distilled variant (fast inference, fewer steps)
if [ ! -f "ltx-2-19b-distilled-fp8.safetensors" ]; then
    echo "Downloading LTX-2 Distilled Checkpoint..."
    wget -O ltx-2-19b-distilled-fp8.safetensors "https://huggingface.co/Lightricks/LTX-2/resolve/main/ltx-2-19b-distilled-fp8.safetensors?download=true"
else
    echo "LTX-2 Distilled Checkpoint already exists"
fi

# Dev variant (higher quality, more steps)
if [ ! -f "ltx-2-19b-dev-fp8.safetensors" ]; then
    echo "Downloading LTX-2 Dev Checkpoint..."
    wget -O ltx-2-19b-dev-fp8.safetensors "https://huggingface.co/Lightricks/LTX-2/resolve/main/ltx-2-19b-dev-fp8.safetensors?download=true"
else
    echo "LTX-2 Dev Checkpoint already exists"
fi

# B. LTX Upscaler
mkdir -p "$COMFY_ROOT/models/latent_upscale_models"
cd "$COMFY_ROOT/models/latent_upscale_models"
if [ ! -f "ltx-2-spatial-upscaler-x2-1.0.safetensors" ]; then
    echo "Downloading LTX Upscaler..."
    wget -O ltx-2-spatial-upscaler-x2-1.0.safetensors "https://huggingface.co/Lightricks/LTX-2/resolve/main/ltx-2-spatial-upscaler-x2-1.0.safetensors?download=true"
else
    echo "LTX Upscaler already exists"
fi

# C. Gemma 3 Text Encoder (Folder Structure)
#    Uses unsloth mirror (ungated, no HF auth required).
#    LTXVGemmaCLIPModelLoader resolves to:
#      gemma-3-12b-it-bnb-4bit/model-00001-of-00002.safetensors
#    The full directory including tokenizer.model must be present.
mkdir -p "$COMFY_ROOT/models/text_encoders"
cd "$COMFY_ROOT/models/text_encoders"
if [ ! -d "gemma-3-12b-it-bnb-4bit" ]; then
    echo "Downloading Gemma 3 12B (bnb-4bit) from unsloth mirror..."
    git clone https://huggingface.co/unsloth/gemma-3-12b-it-bnb-4bit
else
    echo "Gemma 3 already exists"
fi

# Verify tokenizer.model is present (critical file the loader checks for)
if [ ! -f "gemma-3-12b-it-bnb-4bit/tokenizer.model" ]; then
    echo "ERROR: tokenizer.model missing — Gemma clone may be incomplete!"
    echo "Removing and re-downloading..."
    rm -rf gemma-3-12b-it-bnb-4bit
    git clone https://huggingface.co/unsloth/gemma-3-12b-it-bnb-4bit
fi

# ============================================
# PART 5: DOWNLOAD Z-IMAGE-TURBO (SPLIT FILES)
# ============================================
echo ""
echo "--- Setting up Z-Image-Turbo ---"

cd "$COMFY_ROOT/models"

# A. Text Encoder (Qwen) -> models/clip
mkdir -p clip
cd clip
if [ ! -f "qwen_3_4b.safetensors" ]; then
    echo "Downloading Qwen Text Encoder..."
    wget -O qwen_3_4b.safetensors "https://huggingface.co/Comfy-Org/z_image_turbo/resolve/main/split_files/text_encoders/qwen_3_4b.safetensors"
else
    echo "Qwen Text Encoder already exists"
fi
cd ..

# B. Diffusion Model (UNet) -> models/unet
mkdir -p unet
cd unet
if [ ! -f "z_image_turbo_bf16.safetensors" ]; then
    echo "Downloading Z-Image UNet..."
    wget -O z_image_turbo_bf16.safetensors "https://huggingface.co/Comfy-Org/z_image_turbo/resolve/main/split_files/diffusion_models/z_image_turbo_bf16.safetensors"
else
    echo "Z-Image UNet already exists"
fi
cd ..

# C. VAE -> models/vae
mkdir -p vae
cd vae
if [ ! -f "z_image_turbo_ae.safetensors" ]; then
    echo "Downloading Z-Image VAE..."
    wget -O z_image_turbo_ae.safetensors "https://huggingface.co/Comfy-Org/z_image_turbo/resolve/main/split_files/vae/ae.safetensors"
else
    echo "Z-Image VAE already exists"
fi
cd ..

# ============================================
# PART 6: LORAS
# ============================================
echo ""
echo "--- Downloading LoRAs ---"

mkdir -p "$COMFY_ROOT/models/loras"
cd "$COMFY_ROOT/models/loras"

# Distilled LoRA (REQUIRED — Stage 2 of every LTX-2 dev clip)
if [ ! -f "ltx-2-19b-distilled-lora-384.safetensors" ]; then
    echo "Downloading LTX-2 Distilled LoRA..."
    wget -O ltx-2-19b-distilled-lora-384.safetensors \
        "https://huggingface.co/Lightricks/LTX-2/resolve/main/ltx-2-19b-distilled-lora-384.safetensors?download=true"
else
    echo "LTX-2 Distilled LoRA already exists"
fi

# Static Camera LoRA (used for chained WIDE shots in blend mode)
mkdir -p LTX
cd LTX
if [ ! -f "ltx-2-19b-lora-camera-control-static.safetensors" ]; then
    echo "Downloading LTX-2 Static Camera LoRA..."
    wget -O ltx-2-19b-lora-camera-control-static.safetensors \
        "https://huggingface.co/Lightricks/LTX-2-19b-LoRA-Camera-Control-Static/resolve/main/ltx-2-19b-lora-camera-control-static.safetensors?download=true"
else
    echo "LTX-2 Static Camera LoRA already exists"
fi
cd ..

# ============================================
# PART 7: FINAL VERIFICATION
# ============================================
echo ""
echo "=============================================="
echo "MODEL VERIFICATION"
echo "=============================================="

MISSING=""

check_file() {
    if [ -f "$1" ]; then
        echo "  OK: $(basename "$1")"
    else
        echo "  MISSING: $1"
        MISSING="$MISSING $1"
    fi
}

check_dir() {
    if [ -d "$1" ] && [ -f "$1/$2" ]; then
        echo "  OK: $(basename "$1")/ ($2 present)"
    else
        echo "  MISSING: $1/$2"
        MISSING="$MISSING $1/$2"
    fi
}

echo "LTX-2 Checkpoints:"
check_file "$COMFY_ROOT/models/checkpoints/ltx-2-19b-distilled-fp8.safetensors"
check_file "$COMFY_ROOT/models/checkpoints/ltx-2-19b-dev-fp8.safetensors"

echo "LTX Upscaler:"
check_file "$COMFY_ROOT/models/latent_upscale_models/ltx-2-spatial-upscaler-x2-1.0.safetensors"

echo "Gemma 3 Text Encoder:"
check_dir "$COMFY_ROOT/models/text_encoders/gemma-3-12b-it-bnb-4bit" "tokenizer.model"
check_file "$COMFY_ROOT/models/text_encoders/gemma-3-12b-it-bnb-4bit/model-00001-of-00002.safetensors"

echo "LoRAs:"
check_file "$COMFY_ROOT/models/loras/ltx-2-19b-distilled-lora-384.safetensors"
check_file "$COMFY_ROOT/models/loras/LTX/ltx-2-19b-lora-camera-control-static.safetensors"

echo "Z-Image-Turbo:"
check_file "$COMFY_ROOT/models/clip/qwen_3_4b.safetensors"
check_file "$COMFY_ROOT/models/unet/z_image_turbo_bf16.safetensors"
check_file "$COMFY_ROOT/models/vae/z_image_turbo_ae.safetensors"

echo ""
if [ -z "$MISSING" ]; then
    echo "ALL MODELS VERIFIED SUCCESSFULLY!"
else
    echo "WARNING: Some models are missing. Check above for details."
fi

# ============================================
# PART 8: RESTART COMFYUI
# ============================================
echo ""
echo "=============================================="
echo "ALL DONE! Restarting ComfyUI..."
echo "=============================================="

if command -v supervisorctl &> /dev/null; then
    supervisorctl restart comfyui
    echo "ComfyUI restarted with RTX 5090 optimizations + all models loaded!"
else
    echo "Please restart ComfyUI manually."
fi
